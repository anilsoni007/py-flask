name: Deploy to Sandbox Instance
on:
  push:
      branches: 
        - sandbox
  workflow_run: 
    workflows: [python-panda-app]
    types:
      - completed
env:
  ENV_NAME: ${{ github.ref == 'refs/heads/sandbox' && 'sandbox' || 'staging' }}

  
jobs:
  deploy-to-sandbox:
    environment:
      name: sandbox
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_SANDBOX_ROLE }}
          aws-region: ap-south-1

      - name: build docker image
        run: docker build -t ${{ vars.ECR_REG }}/${{ env.ENV_NAME }}/sbx-artifactory:${{ github.sha }} .

      - name: push to ECR
        run: |
          aws ecr get-login-password --region ap-south-1 | docker login --username AWS --password-stdin ${{ vars.ECR_REG }}
          docker push ${{ vars.ECR_REG }}/${{ env.ENV_NAME }}/sbx-artifactory:${{ github.sha }}



      
